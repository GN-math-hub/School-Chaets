<!DOCTYPE html>
<html lang="en">
<head>
    <base href="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="apple-touch-icon" href="/favicon.png" />
    <script>
        window.addEventListener('beforeunload', function (event) {
            event.preventDefault();
            event.returnValue = '';
            return 'Are you sure you want to leave? Any unsaved changes will be lost.';
        });
    </script>
    <!-- Optional: ad scripts can be deferred or removed for performance -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX5VS54ZDW"></script> -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gn-math - Christmas Edition</title>
    <meta name="title" content="GN-Math Christmas" />
    <meta name="description" content="Festive Christmas themed games on GN-Math. Play and enjoy the holiday spirit!" />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX5VS54ZDW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date()); gtag('config', 'G-WX5VS54ZDW');
    </script>

    <style>
        /* --- Christmas Theme CSS --- */

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --primary: #FF0000; /* Red for Christmas */
            --primary-hover: #00FF00; /* Green hover */
            --accent: #FFA500; /* Orange for accents */
            --success: #00FF00; /* Green */
            --warning: #FFFF00; /* Yellow */
            --text: #FFFFFF; /* White text */
            --bg: #0B3D91; /* Deep blue background for night sky */
            --surface: #222; /* Dark surface for contrast */
            --border: #FFFFFF; /* White border */
            --radius: 12px;
            --font-family: 'Press Start 2P', cursive, sans-serif;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0b3d91, #001f3f);
            color: var(--text);
            background-image: 
                radial-gradient(circle at top right, #FF0000, transparent 70%),
                radial-gradient(circle at bottom left, #00FF00, transparent 70%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header with Christmas colors and festive glow */
        header {
            background: linear-gradient(45deg, #FF0000, #FFA500);
            color: var(--text);
            font-family: var(--font-family);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        /* Glitch/glow animation for header */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 0); }
            40% { transform: translate(2px, 0); }
            60% { transform: translate(-2px, 0); }
            80% { transform: translate(2px, 0); }
            100% { transform: translate(0); }
        }

        header {
            animation: glitch 2s infinite;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #FF0000, #00FF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 10px #FFF, 0 0 20px #0F0;
        }

        /* Search and controls styling with festive colors */
        .search-container {
            display: flex;
            flex: 1;
            max-width: 500px;
            gap: 0.75rem;
        }

        #searchBar {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid #FFFFFF;
            border-radius: var(--radius);
            background: #333;
            color: #FFF;
            font-family: var(--font-family);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        #searchBar:focus {
            background: #555;
            border-color: #FFFF00;
            box-shadow: 0 0 10px #FFFF00, inset 0 0 10px #FFFF00;
        }

        #sortOptions {
            padding: 0.875rem 1rem;
            border: 2px solid #FFFFFF;
            border-radius: var(--radius);
            background: #333;
            color: #FFF;
            font-family: var(--font-family);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #sortOptions:hover {
            background: #555;
            border-color: #FFA500;
            box-shadow: 0 0 10px #FFA500;
        }

        /* Control buttons styling with festive glow */
        .control-buttons {
            display: flex;
            gap: 0.5rem;
        }

        #settings {
            background: linear-gradient(45deg, #FF0000, #FFA500);
            border: none;
            color: #FFF;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--radius);
            box-shadow: 0 0 10px #FFF, 0 0 20px #FF0;
            display: flex;
            align-items: center;
        }

        #settings:hover {
            box-shadow: 0 0 20px #FFF, inset 0 0 20px #FF0;
        }

        main {
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: auto;
        }

        /* Zone grid styles with festive borders and glow */
        #container, #featuredZones {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .zone-item {
            background: #222;
            border: 2px solid #FFF;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 10px #FF0000, inset 0 0 10px #FF0000;
        }

        .zone-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 0 20px #FF0000, inset 0 0 20px #FF0000;
            border-color: #00FF00;
        }

        .zone-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
            transition: transform 0.4s ease;
        }

        .zone-item:hover img {
            transform: scale(1.05);
        }

        .zone-item button {
            background: transparent;
            color: #00FF00;
            border: none;
            padding: 1.25rem 1rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 0 5px #FFF;
            transition: all 0.3s ease;
        }

        .zone-item:hover button {
            color: #FF0000;
            background: rgba(255,255,255,0.1);
        }

        /* Zone viewer overlay with glow */
        #zoneViewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            flex-direction: column;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Zone header inside viewer with festive theme */
        .zone-header {
            background: linear-gradient(45deg, #FF0000, #00FF00);
            color: #FFF;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #FFF;
        }

        #zoneName {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 0 5px #FFF, 0 0 10px #FF0;
        }

        #zoneAuthor {
            font-size: 14px;
            color: #FFF;
            text-decoration: underline;
        }

        .zone-controls {
            display: flex;
            gap: 0.75rem;
        }

        .zone-controls button {
            background: #222;
            border: 2px solid #FFF;
            color: #FFF;
            padding: 0.625rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .zone-controls button:hover {
            background: #444;
            border-color: #FFA500;
            box-shadow: 0 0 10px #FFA500;
        }

        #zoneFrame {
            flex: 1;
            border: none;
            width: 100%;
            height: calc(100vh - 80px);
        }

        /* Popup overlay with glow */
        #popupOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .popup {
            background: #222;
            border: 2px solid #FFA500;
            border-radius: var(--radius);
            max-width: 520px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
            padding: 1rem;
            box-shadow: 0 0 20px #FFA500, inset 0 0 20px #FFA500;
            animation: slideInScale 0.3s ease;
        }

        @keyframes slideInScale {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        #popupTitle {
            margin: 0;
            font-size: 1.25rem;
            font-weight: bold;
            color: #FFA500;
        }

        #popupClose {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #FFA500;
            cursor: pointer;
        }

        #popupClose:hover {
            color: #FF0000;
        }

        #popupBody {
            color: #FFF;
        }

        /* Settings button style */
        #settings-button {
            width: 100%;
            padding: 0.875rem 1rem;
            background: linear-gradient(45deg, #FF0000, #FFA500);
            border: none;
            border-radius: var(--radius);
            color: #FFF;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 10px #FFF, 0 0 20px #FFA500;
        }

        #settings-button:hover {
            box-shadow: 0 0 20px #FFF, inset 0 0 20px #FFA500;
        }

        /* Footer with glow and colors */
        footer {
            background: linear-gradient(45deg, #FF0000, #00FF00);
            color: #FFF;
            text-align: center;
            padding: 1rem;
            font-family: var(--font-family);
            font-size: 12px;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 -0 15px rgba(255,255,255,0.3);
        }

        /* Responsive adjustments */
        @media(max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            #searchBar {
                width: 100%;
            }
            main {
                padding: 1.5rem 1rem;
            }
            #container, #featuredZones {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <div class="logo">üéÑ gn-math By RylanüéÖ</div>
            <div class="search-container" style="display:flex; align-items:center; gap:0.75rem;">
                <input type="text" id="searchBar" placeholder="Search zones..." oninput="filterZones()" />
                <select id="sortOptions" onchange="sortZones()">
                    <option value="name">Name</option>
                    <option value="id">ID (Date)</option>
                    <option value="popular">Popular</option>
                </select>
            </div>
            <div class="control-buttons">
                <button id="settings" style="background:linear-gradient(45deg, #FF0000, #FFA500);" onclick="/* your settings logic */">
                    Rylan rude
                </button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main>
        <details id="featuredZonesWrapper" open>
            <summary id="allZonesSummary" style="font-size: 1.2rem; font-weight: bold; cursor: pointer;">üéÑ Featured Zones üéÑ</summary>
            <div id="featuredZones" class="zone-container"></div>
        </details>
        <br /><hr /><br />
        <details id="allZonesWrapper" open>
            <summary id="allSummary" style="font-size: 1.2rem; font-weight: bold; cursor: pointer;">üéÖ All Zones üéÖ</summary>
            <div id="container">Loading...</div>
        </details>
    </main>

    <!-- Zone viewer overlay -->
    <div id="zoneViewer" style="display: none;">
        <div class="zone-header">
            <div class="zone-title">
                <h2 id="zoneName">Zone Name</h2>
                <span id="zoneId" style="display:none;"></span>
                <a id="zoneAuthor" href="#" target="_blank" style="color:#FFF;">by Author</a>
            </div>
            <div class="zone-controls">
                <button onclick="fullscreenZone()">üé•</button>
                <button onclick="aboutBlank()">üåê</button>
                <button onclick="downloadZone()">üíæ</button>
                <button onclick="closeZone()">‚úñ</button>
            </div>
        </div>
        <iframe id="zoneFrame"></iframe>
    </div>

    <!-- Popup overlay -->
    <div id="popupOverlay" style="display: none;">
        <div class="popup">
            <div class="popup-header">
                <h3 id="popupTitle">Title</h3>
                <button id="popupClose" onclick="closePopup()">√ó</button>
            </div>
            <div id="popupBody">Content will be here</div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Declare and initialize container elements
        const container = document.getElementById('container');
        const featuredContainer = document.getElementById('featuredZones');
        const zoneViewer = document.getElementById('zoneViewer');
        let zoneFrame = document.getElementById('zoneFrame');
        const searchBar = document.getElementById('searchBar');
        const sortOptions = document.getElementById('sortOptions');

        const zonesurls = [
            "https://cdn.jsdelivr.net/%67%68/%67%6e%2d%6d%61%74%68/%61%73%73%65%74%73@%6d%61%69%6e/%7a%6f%6e%65%73%2e%6a%73%6f%6e",
            "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
            "https://cdn.jsdelivr.net/gh/gn-math/assets@master/zones.json",
            "https://cdn.jsdelivr.net/gh/gn-math/assets/zones.json"
        ];
        let zonesURL = zonesurls[Math.floor(Math.random() * zonesurls.length)];
        const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
        const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";

        let zones = [];
        let popularityData = {};

        async function listZones() {
            try {
                let sharesponse;
                let shajson;
                let sha;
                try {
                    sharesponse = await fetch("https://api.github.com/repos/gn-math/assets/commits?t="+Date.now());
                } catch (error) {}
                if (sharesponse && sharesponse.status === 200) {
                    try {
                        shajson = await sharesponse.json();
                        sha = shajson[0]['sha'];
                        if (sha) {
                            zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
                        }
                    } catch (error) {
                        try {
                            let secondarysharesponse = await fetch("https://raw.githubusercontent.com/gn-math/xml/refs/heads/main/sha.txt?t="+Date.now());
                            if (secondarysharesponse && secondarysharesponse.status === 200) {
                                sha = (await secondarysharesponse.text()).trim();
                                if (sha) {
                                    zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
                                }
                            }
                        } catch(error) {}
                    }
                }
                const response = await fetch(zonesURL+"?t="+Date.now());
                const json = await response.json();
                zones = json;
                zones[0].featured = true; // always gonna be the discord
                await fetchPopularity();
                sortZones();
                const search = new URLSearchParams(window.location.search);
                const id = search.get('id');
                const embed = window.location.hash.includes("embed");
                if (id) {
                    const zone = zones.find(zone => zone.id + '' == id + '');
                    if (zone) {
                        if (embed) {
                            if (zone.url.startsWith("http")) {
                                window.open(zone.url, "_blank");
                            } else {
                                const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
                                fetch(url+"?t="+Date.now()).then(response => response.text()).then(html => {
                                    document.documentElement.innerHTML = html;
                                    const popup = document.createElement("div");
                                    popup.style.position = "fixed";
                                    popup.style.bottom = "20px";
                                    popup.style.right = "20px";
                                    popup.style.backgroundColor = "#cce5ff";
                                    popup.style.color = "#004085";
                                    popup.style.padding = "10px";
                                    popup.style.border = "1px solid #b8daff";
                                    popup.style.borderRadius = "5px";
                                    popup.style.boxShadow = "0px 0px 10px rgba(0,0,0,0.1)";
                                    popup.style.fontFamily = "Arial, sans-serif";

                                    popup.innerHTML = `Play more games at <a href="https://gn-math.github.io" target="_blank" style="color:#004085; font-weight:bold;">https://gn-math.github.io</a>!`;

                                    const closeBtn = document.createElement("button");
                                    closeBtn.innerText = "‚úñ";
                                    closeBtn.style.marginLeft = "10px";
                                    closeBtn.style.background = "none";
                                    closeBtn.style.border = "none";
                                    closeBtn.style.cursor = "pointer";
                                    closeBtn.style.color = "#004085";
                                    closeBtn.style.fontWeight = "bold";

                                    closeBtn.onclick = () => popup.remove();
                                    popup.appendChild(closeBtn);
                                    document.body.appendChild(popup);
                                    document.documentElement.querySelectorAll('script').forEach(oldScript => {
                                        const newScript = document.createElement('script');
                                        if (oldScript.src) {
                                            newScript.src = oldScript.src;
                                        } else {
                                            newScript.textContent = oldScript.textContent;
                                        }
                                        document.body.appendChild(newScript);
                                    });
                                }).catch(error => alert("Failed to load zone: " + error));
                            }
                        } else {
                            openZone(zone);
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `Error loading zones: ${error}`;
            }
        }

        async function fetchPopularity() {
            try {
                const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
                const data = await response.json();
                data.forEach(file => {
                    const idMatch = file.name.match(/\/(\d+)\.html$/);
                    if (idMatch) {
                        const id = parseInt(idMatch[1]);
                        popularityData[id] = file.hits.total;
                    }
                });
            } catch (error) {
                popularityData[0] = 0;
            }
        }

        function sortZones() {
            const sortBy = sortOptions.value;
            if (sortBy === 'name') {
                zones.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'id') {
                zones.sort((a, b) => a.id - b.id);
            } else if (sortBy === 'popular') {
                zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
            }
            zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
            if (featuredContainer.innerHTML === "") {
                const featured = zones.filter(z => z.featured);
                displayFeaturedZones(featured);
            }
            displayZones(zones);
        }

        function displayFeaturedZones(featuredZones) {
            featuredContainer.innerHTML = "";
            featuredZones.forEach((file, index) => {
                const zoneItem = document.createElement("div");
                zoneItem.className = "zone-item";
                zoneItem.onclick = () => openZone(file);
                const img = document.createElement("img");
                img.dataset.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
                img.alt = file.name;
                img.loading = "lazy"; // lazy load images
                img.className = "lazy-zone-img";
                zoneItem.appendChild(img);
                const button = document.createElement("button");
                button.textContent = file.name;
                button.onclick = (event) => {
                    event.stopPropagation();
                    openZone(file);
                };
                zoneItem.appendChild(button);
                featuredContainer.appendChild(zoneItem);
            });
            if (featuredContainer.innerHTML === "") {
                featuredContainer.innerHTML = "No featured zones found.";
            } else {
                document.getElementById("allZonesSummary").textContent = `Featured Zones (${featuredZones.length})`;
            }
            // Lazy load images
            const lazyImages = document.querySelectorAll('#featuredZones img.lazy-zone-img');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !zoneViewer.hidden) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove("lazy-zone-img");
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: "100px",
                threshold: 0.1
            });
            lazyImages.forEach(img => {
                imageObserver.observe(img);
            });
        }

        function displayZones(zones) {
            const container = document.getElementById('container');
            container.innerHTML = "";
            zones.forEach((file, index) => {
                const zoneItem = document.createElement("div");
                zoneItem.className = "zone-item";
                zoneItem.onclick = () => openZone(file);
                const img = document.createElement("img");
                img.dataset.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
                img.alt = file.name;
                img.loading = "lazy"; // lazy load images
                img.className = "lazy-zone-img";
                zoneItem.appendChild(img);
                const button = document.createElement("button");
                button.textContent = file.name;
                button.onclick = (event) => {
                    event.stopPropagation();
                    openZone(file);
                };
                zoneItem.appendChild(button);
                container.appendChild(zoneItem);
            });
            if (container.innerHTML === "") {
                container.innerHTML = "No zones found.";
            } else {
                document.getElementById("allSummary").textContent = `All Zones (${zones.length})`;
            }
            // Lazy load images
            const lazyImages = document.querySelectorAll('img.lazy-zone-img');
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !zoneViewer.hidden) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove("lazy-zone-img");
                        obs.unobserve(img);
                    }
                });
            }, {
                rootMargin: "100px",
                threshold: 0.1
            });
            lazyImages.forEach(img => {
                observer.observe(img);
            });
        }

        function filterZones() {
            const query = searchBar.value.toLowerCase();
            const filteredZones = zones.filter(zone => zone.name.toLowerCase().includes(query));
            if (query.length !== 0) {
                document.getElementById("featuredZonesWrapper").removeAttribute("open");
            }
            displayZones(filteredZones);
        }

        function openZone(file) {
            if (file.url.startsWith("http")) {
                window.open(file.url, "_blank");
            } else {
                const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
                fetch(url + "?t=" + Date.now())
                    .then(res => res.text())
                    .then(html => {
                        if (zoneFrame.contentDocument === null) {
                            zoneFrame = document.createElement("iframe");
                            zoneFrame.id = "zoneFrame";
                            document.getElementById('zoneViewer').appendChild(zoneFrame);
                        }
                        zoneFrame.contentDocument.open();
                        zoneFrame.contentDocument.write(html);
                        zoneFrame.contentDocument.close();
                        document.getElementById('zoneName').textContent = file.name;
                        document.getElementById('zoneId').textContent = file.id;
                        document.getElementById('zoneAuthor').textContent = "by " + file.author;
                        if (file.authorLink) {
                            document.getElementById('zoneAuthor').href = file.authorLink;
                        }
                        document.getElementById('zoneViewer').style.display = "flex";
                        const url = new URL(window.location);
                        url.searchParams.set('id', file.id);
                    })
                    .catch(error => alert("Failed to load zone: " + error));
            }
        }

        function aboutBlank() {
            const newWindow = window.open("about:blank", "_blank");
            let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent).url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
            fetch(zone + "?t=" + Date.now())
                .then(response => response.text())
                .then(html => {
                    if (newWindow) {
                        newWindow.document.open();
                        newWindow.document.write(html);
                        newWindow.document.close();
                    }
                });
        }

        function closeZone() {
            document.getElementById('zoneViewer').style.display = "none";
            document.getElementById('zoneFrame').remove();
            const url = new URL(window.location);
            url.searchParams.delete('id');
            history.pushState(null, '', url.toString());
        }

        function downloadZone() {
            let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent);
            fetch(zone.url.replace("{HTML_URL}", htmlURL) + "?t=" + Date.now())
                .then(res => res.text())
                .then(text => {
                    const blob = new Blob([text], {
                        type: "text/plain;charset=utf-8"
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = zone.name + ".html";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
        }

        function fullscreenZone() {
            if (zoneFrame.requestFullscreen) {
                zoneFrame.requestFullscreen();
            } else if (zoneFrame.mozRequestFullScreen) {
                zoneFrame.mozRequestFullScreen();
            } else if (zoneFrame.webkitRequestFullscreen) {
                zoneFrame.webkitRequestFullscreen();
            } else if (zoneFrame.msRequestFullscreen) {
                zoneFrame.msRequestFullscreen();
            }
        }

        function closePopup() {
            document.getElementById('popupOverlay').style.display = "none";
        }

        // Initialize
        listZones();
    </script>
    <script>
        const search = new URLSearchParams(window.location.search);
        const privacy = search.get('privacy');
        if (privacy) {
            // Load privacy policy if needed
        }
    </script>
</body>
</html>
